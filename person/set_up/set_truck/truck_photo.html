<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="format-detection" content="telephone=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0,minimum-scale=1.0">
		<title>车辆图片</title>
		<link rel="stylesheet" type="text/css" href="../../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../../css/mui.css"/>
		<!--<link rel="stylesheet" type="text/css" href="../../../css/nav_table.css"/>-->
		<link rel="stylesheet" type="text/css" href="../../../css/truck_photo.css"/>
		<link rel="stylesheet" type="text/css" href="../../../css/reset.css"/>
		<script src="../../../js/public.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../../js/jquery-1.10.2.min.js" type="text/javascript" charset="utf-8"></script>
	</head>
	<script type="text/javascript">
		mui.init()
	</script>
	<body>
		<header class="mui-bar mui-bar-nav mui-action-back">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: #fff;"></a>
		    <h1 class="mui-title">车辆图片</h1>
		    
		    <!--<span><img src="../img/faxian_jia.png"/></span>-->
		</header>
		<div class="mui-content">
			<div class="main">
				<div class="main_li">
					<div class="main_li_photo" >
						<div class='photofather'>
							<div class="photo image-item" onclick="showActionSheet(this)" data-type="1" id="imgone">
								<img src="../../../img/cheliangzhaopian.png" id="picone"/>
							</div>
						</div>
						
					</div>
					<div class="main_li_name">添加行驶证</div>
				</div>
				<input type="hidden" id="ckjl.id" name="ckjl.id" value="430">
				<div class="main_li">
					<div class="main_li_photo" >
						<div class='photofather1'>
							<div class="photo image-item" onclick="showActionSheet(this)" data-type="2" id="imgtwo">
								<img src="../../../img/cheliangzhaopian.png" id="pictwo"/>
							</div>
						</div>
					</div>
					<div class="main_li_name">添加车头照</div>
				</div>
				<div class="main_li">
					<div class="main_li_photo">
						<div class='photofather2'>
							<div class="photo image-item" onclick="showActionSheet(this)" data-type="3" id="imgthree">
								<img src="../../../img/cheliangzhaopian.png" id="picthree"/>
							</div>
						</div>
					</div>
					<div class="main_li_name">45度车身照</div>
				</div>
				<div class="main_li">
					<div class="main_li_photo" >
						<div class='photofather3'>
							<div class="photo image-item" onclick="showActionSheet(this)" data-type="4" id="imgfour">
								<img src="../../../img/cheliangzhaopian.png" id="picfour"/>
							</div>
						</div>
					</div>
					<div class="main_li_name">车尾照</div>
				</div>
				
				<div class="main_sure "> 
					<div class="sure" onclick="uploadImg()">完成</div>
				</div>
			</div>
			
		</div>
		<script type="text/javascript">
		var img_num = 6;//
        var big_img_num = 1;//最大上传图片数
        var urL=location.href;
		var userid=localStorage.getItem('user_id')
        var bg_car=getUrl(urL).bg_car;
        var sijiid=getUrl(urL).sijiid;
		
		var procinstid = 0;
		//初始化页面执行操作  

		//加载页面初始化需要加载的图片信息  
		//或者相册IMG_20160704_112620.jpg  
		//imgId:图片名称：1467602809090或者IMG_20160704_112620  
		//imgkey:字段例如：F_ZDDZZ  
		//ID：站点编号ID,例如429  
		//src：src="file:///storage/emulated/0/Android/data/io.dcloud.HBuilder/.HBuilder/apps/HBuilder/doc/upload/F_ZDDZZ-1467602809090.jpg"  
		function showImgDetail(imgId, imgkey, id, src,type) {
			var html = "";

			
				if(type==1){
					html += '<div class="imgs imgitem" id="Img' + imgId + imgkey + '">';
					html += '<img class="picBig" data-preview-src="" data-preview-group="1" ' + src + '/>';
					html += '<span class="del_icon" onclick="delImg(\'' + imgId + '\',\'' + imgkey + '\',' + id + ')"><img src="../../../img/shangpinxiangqing_quxiao.png" alt="" /></span>';
					html += '</div>';
					$(".photofather").append(html);
					$('#imgone').hide();
				}else if(type==2){
					html += '<div class="imgs imgitem" id="Img' + imgId + imgkey + '">';
					html += '<img class="picBig" data-preview-src="" data-preview-group="1" ' + src + '/>';
					html += '<span class="del_icon" onclick="delImg(\'' + imgId + '\',\'' + imgkey + '\',' + id + ')"><img src="../../../img/shangpinxiangqing_quxiao.png" alt="" /></span>';
					html += '</div>';
					$(".photofather1").append(html);
					$("#imgtwo").hide()
				}else if(type==3){
					html += '<div class="imgs imgitem" id="Img' + imgId + imgkey + '">';
					html += '<img class="picBig" data-preview-src="" data-preview-group="1" ' + src + '/>';
					html += '<span class="del_icon" onclick="delImg(\'' + imgId + '\',\'' + imgkey + '\',' + id + ')"><img src="../../../img/shangpinxiangqing_quxiao.png" alt="" /></span>';
					html += '</div>';
					$(".photofather2").append(html);
					$("#imgthree").hide()
				}else if(type==4){
					html += '<div class="imgs imgitem" id="Img' + imgId + imgkey + '">';
					html += '<img class="picBig" data-preview-src="" data-preview-group="1" ' + src + '/>';
					html += '<span class="del_icon" onclick="delImg(\'' + imgId + '\',\'' + imgkey + '\',' + id + ')"><img src="../../../img/shangpinxiangqing_quxiao.png" alt="" /></span>';
					html += '</div>';
					$(".photofather3").append(html);
					$("#imgfour").hide()
				}
			
		}
		//删除图片  
		//imgId:图片名称：IMG_20160704_112614  
		//imgkey:字段，例如F_ZDDZZ  
		//ID：站点编号ID，例如429  
		function delImg(imgId, imgkey, id) {
			var bts = ["是", "否"];
			plus.nativeUI.confirm("是否删除图片？", function(e) {
				
				var i = e.index;
				if(i == 0) {
					var itemname = id + "img-" + imgkey; //429img-F_ZDDZZ  
					
					var itemvalue = plus.storage.getItem(itemname);
					//{IMG_20160704_112614,_doc/upload/F_ZDDZZ-IMG_20160704_112614.jpg,file:///storage/emulated/0/Android/data/io.dcloud...../doc/upload/F_ZDDZZ-1467602809090.jpg}  
					if(itemvalue != null) {
						var index = itemvalue.indexOf(imgId + ",");
						if(index == -1) { //没有找到  
							delImgfromint(imgId, imgkey, id, index);
						} else {
							delImgFromLocal(itemname, itemvalue, imgId, imgkey, index); //修改，加了一个index参数  
						}

					} else {
						delImgfromint(imgId, imgkey, id);
					}
				}
			}, "图片管理", bts);
			/*var isdel = confirm("是否删除图片？");  
			if(isdel == false){  
			    return;  
			}*/

		}

		function delImgFromLocal(itemname, itemvalue, imgId, imgkey, index) {
			var wa = plus.nativeUI.showWaiting();
			var left = itemvalue.substr(0, index - 1);
			var right = itemvalue.substring(index, itemvalue.length);
			var end = right.indexOf("}");
			right = right.substring(end + 1, right.length);
			var newitem = left + right;
			plus.storage.setItem(itemname, newitem);
			
			$("#Img" + imgId + imgkey).remove();
			$('#imgone').show();
			$('#imgtwo').show()
			$('#imgthree').show()
			$('#imgfour').show()
			wa.close();
		}
		//选取图片的来源，拍照和相册  
		function showActionSheet(conf) {
			
			var divid = conf.id;
			var imgNum = $('.addpicitem .imgs').length;
			if(imgNum>=big_img_num){
				plus.nativeUI.alert('最多只能选择'+big_img_num+'张！');
				img_num = 0;
				return;
			}else {
				img_num = big_img_num - imgNum;
			}
			var actionbuttons = [{
				title: "拍照"
			}, {
				title: "相册选取"
			}];
			var actionstyle = {
				title: "选择照片",
				cancel: "取消",
				buttons: actionbuttons
			};
			plus.nativeUI.actionSheet(actionstyle, function(e) {
				if(e.index == 1) {
					getImage(divid,$(conf).attr('data-type'));
				} else if(e.index == 2) {
					galleryImg(divid,$(conf).attr('data-type'));
				}
			});
		}
		var lfs = null;//保留图片
		function galleryImg(divid,type) {
			plus.gallery.pick(function(e) {
				//alert(e.files.length);
				var zm = 0;
				setTimeout(file, 100);
				
				function file() {
					plus.io.resolveLocalFileSystemURL(e.files[zm], function(entry) {
						compressImage(entry.toLocalURL(), entry.name, divid,type);
					}, function(e) {
						plus.nativeUI.toast("读取拍照文件错误：" + e.message);
					});
					zm++;
					if(zm<e.files.length){
						setTimeout(file, 30);
					}
				}
				lfs = e.files;

			}, function(e) {
				console.log("取消选择图片");
			}, {
				filename: "_doc/camera/",
				filter: "image",
				multiple: true,
				maximum:img_num,
				system:false,
				onmaxed:function(){
                	plus.nativeUI.alert('最多只能选择'+big_img_num+'张！');
            	},
			});
		}
		// 拍照  
		function getImage(divid,type) {
			if(img_num <= 0) {
				return;
			}
			var cmr = plus.camera.getCamera();
			cmr.captureImage(function(p) {
				//alert(p);//_doc/camera/1467602809090.jpg  
				plus.io.resolveLocalFileSystemURL(p, function(entry) {
					//alert(entry.toLocalURL());//file:///storage/emulated/0/Android/data/io.dcloud...../doc/camera/1467602809090.jpg  
					//alert(entry.name);//1467602809090.jpg  
					compressImage(entry.toLocalURL(), entry.name, divid);
				}, function(e) {
					plus.nativeUI.toast("读取拍照文件错误：" + e.message);
				});
			}, function(e) {}, {
				filename: "_doc/camera/",
				index: 1
			});
		}
		//压缩图片  
		function compressImage(url, filename, divid,type) {
			var name = "_doc/upload/" + divid + "-" + filename; //_doc/upload/F_ZDDZZ-1467602809090.jpg  
			plus.zip.compressImage({
					src: url, //src: (String 类型 )压缩转换原始图片的路径  
					dst: name, //压缩转换目标图片的路径  
					quality: 20, //quality: (Number 类型 )压缩图片的质量.取值范围为1-100  
					overwrite: true //overwrite: (Boolean 类型 )覆盖生成新文件  
				},
				function(event) {
					//uploadf(event.target,divid);  
					var path = name; //压缩转换目标图片的路径  
					//event.target获取压缩转换后的图片url路  
					//filename图片名称  
					saveimage(event.target, divid, filename, path,type);
				},
				function(error) {
					plus.nativeUI.toast("压缩图片失败，请稍候再试");
				});
		}
		//保存信息到本地  
		/**  
		 *   
		 * @param {Object} url  图片的地址  
		 * @param {Object} divid  字段的名称  
		 * @param {Object} name   图片的名称  
		 */
		function saveimage(url, divid, name, path,type) {
			//alert(url);//file:///storage/emulated/0/Android/data/io.dcloud...../doc/upload/F_ZDDZZ-1467602809090.jpg  
			//alert(path);//_doc/upload/F_ZDDZZ-1467602809090.jpg  
			var state = 0;
			var wt = plus.nativeUI.showWaiting();
			//  plus.storage.clear();   
			name = name.substring(0, name.indexOf(".")); //图片名称：1467602809090  
			var id = document.getElementById("ckjl.id").value;
			var itemname = id + "img-"+ divid; //429img-
			var itemvalue = plus.storage.getItem(itemname);
			if(itemvalue == null) {
				itemvalue = "{" + name + "," + path + "," + url + "}"; //{IMG_20160704_112614,_doc/upload/F_ZDDZZ-IMG_20160704_112614.jpg,file:///storage/emulated/0/Android/data/io.dcloud...../doc/upload/F_ZDDZZ-1467602809090.jpg}  
			} else {
				itemvalue = itemvalue + "{" + name + "," + path + "," + url + "}";
			}
			plus.storage.setItem(itemname, itemvalue);
//				mui.alert(itemname)

			
			var src = 'src="' + url + '"';
			//alert("itemvalue="+itemvalue);  
			showImgDetail(name, divid, id, src,type);
//			uploadImg(type)
			wt.close();
		}

//		var image1;
//		var image2;
//		var image3;
//		var image4;
	
	//上传图片
	function uploadImg(){
//		var havepublish=sessionStorage.getItem('havepublish');
	
		
		var wa = plus.nativeUI.showWaiting();
			var DkeyNames = [];
		var id = document.getElementById("ckjl.id").value;
		var length = id.toString().length;
		var idnmae = id.toString();
		var numKeys = plus.storage.getLength();
		var parms = {};
		var type=type;
//		if(numKeys == 0){
//				wa.close();
//				return;
//		}
		var task = plus.uploader.createUpload(globalUrl+'index.php/Mobile/JkUser/testUploadPic',{
			method: "POST"
		},function(t, status){
			wa.close();
			plus.storage.clear(); 
			var data = JSON.parse(t.responseText);
//			  alert(JSON.stringify(data));
//			  return;
			if(status==200){
				var image1;
				var image2;
				var image3;
				var image4;
				if(data==' '||data==undefined||data==null){
                     mui.toast('上传失败');
                     return;
                    
                }else{
                	var files=data.paths;
                	
                	if(bg_car=='null'||bg_car==''||bg_car==undefined||bg_car==2){
                		if(files.length<4){
                			mui.toast('请完整上传图片信息');
		               		shuaxin()
		               		return;
                		}else if(files.length==4){
                			for(var i=0;i<4;i++){
                				image1=files[0];
		                		
		                	
		                		image2=files[1];
		                	
		                		image3=files[2];
		                	
		                		image4=files[3];
		                	}	
		                		$.ajax({
				                	type:"post",
				                	url:globalUrl+"index.php/Mobile/JkUser/bangche",
				                	data:{user_id:userid,image1:image1,image2:image2,image3:image3,image4:image4,id:5},
				                	dataType:'json',
				                	success:function(res){
				              		var data=res.status;
			//	              		alert(JSON.stringify(data))
					              		if(data==1){
					              			mui.toast('提交成功');
					              			sessionStorage.setItem('havepublish','0')
					              			mui.back()
					              		}else{
					              			mui.toast(res.msg);
					              			
					              		}
				                	}
				                });
                			
                			
                		}
                	}else if(bg_car==0){
                		if(files.length==0){
                			mui.toast('请上传再修改');
                			return;
                		}else{
                			for(var i=0;i<4;i++){
                				image1=files[0];
		                		
		                	
		                		image2=files[1];
		                	
		                		image3=files[2];
		                	
		                		image4=files[3];
		                	}	
		                		$.ajax({
				                	type:"post",
				                	url:globalUrl+"index.php/Mobile/JkUser/bangche",
				                	data:{id:sijiid ,user_id:userid,image1:image1,image2:image2,image3:image3,image4:image4},
				                	dataType:'json',
				                	success:function(res){
				              		var data=res.status;
//				              	alert(JSON.stringify(res))
					              		if(data==0){
					              			mui.toast('提交成功');
//					              			sessionStorage.setItem('havepublish','0')
					              			mui.back()
					              		}else{
					              			mui.toast(res.msg);
					              			
					              		}
				                	}
				                }); 
                			
                		}
                		
                	}else{
                		mui.toast('你已绑定车辆，如需更改请联系客服');
                		return;
                	}
                	
                	
//              	alert(files);return 
//              	if(files.length<4){
//              		if(bg_car==null||bg_car==''||bg_car==undefined){
//              			mui.toast('请完整上传图片信息');
//		               		shuaxin()
//		               		return;
//              		}else if(bg_car==0){
//              			for(var i=0;i<4;i++){
//              		
//		                		image1=files[0];
//		                		
//		                	
//		                		image2=files[1];
//		                	
//		                		image3=files[2];
//		                	
//		                		image4=files[3];
//		                		
//		                		$.ajax({
//				                	type:"post",
//				                	url:globalUrl+"index.php/Mobile/JkUser/bangche",
//				                	data:{id:sijiid ,user_id:userid,image1:image1,image2:image2,image3:image3,image4:image4,id:5},
//				                	dataType:'json',
//				                	success:function(res){
//				              		var data=res.status;
//			//	              		alert(JSON.stringify(data))
//					              		if(data==1){
//					              			mui.toast('提交成功');
//					              			sessionStorage.setItem('havepublish','0')
//					              			mui.back()
//					              		}else{
//					              			mui.toast(res.msg);
//					              			
//					              		}
//				                	}
//				                }); 
//		                		
//		                		
//				                
//		                	}
//              		}else{
//              			mui.toast('你已绑定车辆，如需更改请联系客服');
//              			return;
//              		}
//	               		
//             		}
                	
//              	if(files.length==4){
//              		if(bg_car==null||bg_car==''||bg_car==undefined){
//              			for(var i=0;i<4;i++){
//              		
//		                		image1=files[0];
//		                		
//		                	
//		                		image2=files[1];
//		                	
//		                		image3=files[2];
//		                	
//		                		image4=files[3];
//		                		
//		                		$.ajax({
//				                	type:"post",
//				                	url:globalUrl+"index.php/Mobile/JkUser/bangche",
//				                	data:{user_id:userid,image1:image1,image2:image2,image3:image3,image4:image4,id:5},
//				                	dataType:'json',
//				                	success:function(res){
//				              		var data=res.status;
//			//	              		alert(JSON.stringify(data))
//					              		if(data==1){
//					              			mui.toast('提交成功');
//					              			sessionStorage.setItem('havepublish','0')
//					              			mui.back()
//					              		}else{
//					              			mui.toast(res.msg);
//					              			
//					              		}
//				                	}
//				                });
//		                		
//				                
//		                	}
//              		}
//             			
//             		}
 
//                 mui.toast('上传成功');

                }

              
//             return false;
                 

			}else{
				wa.close();
				plus.storage.clear(); 
				mui.toast('上传失败');
				return;
			}
		})
            task.addData( "dir_name", "z_bc" );
			var imgArray = [];//上传图片的id（多少添加图片按钮 ）
			$('.image-item').each(function(){
				imgArray.push($(this).attr('id'));
			});
			for(var i = 0; i < imgArray.length; i++) {
				var itemkey = id + 'img-' + imgArray[i];//存储图片的下标
				if(plus.storage.getItem(itemkey) != null) {
					var itemvalue = plus.storage.getItem(itemkey).split("{");
					for(var img = 1; img < itemvalue.length; img++) {
						var imgname = itemvalue[img].substr(0, itemvalue[img].indexOf(","));
						var imgurl = itemvalue[img].substring(itemvalue[img].indexOf(",") + 1, itemvalue[img].lastIndexOf(","));
						task.addFile(imgurl, {
							key: imgurl
						});
					}
				}
			}
			task.start();
	}

     $.ajax({
    	type:"post",
    	url:globalUrl+"index.php/Mobile/JkLine/getSijiCar",
    	data:{user_id:userid},
    	dataType:'json',
    	success:function(res){
    		var data=res.info;
    		
    		if(data.image1!=''&&data.image2!=''&&data.image3!=''&&data.image4!=''&&data.image1!=undefined&&data.image2!=undefined&&data.image3!=undefined&&data.image4!=undefined){
    			var str1 = data.image1;
    			var str2 = data.image2;
    			var str3 = data.image3;
    			var str4 = data.image4;
//  			if(str1.indexOf("imgone") != -1){
//  				$('#picone').attr('src',picUrl+data.image1);
//  			}else if(str2.indexOf("imgtwo") != -1){
//  				$('#pictwo').attr('src',picUrl+data.image2);
//  			}else if(str3.indexOf("imgthree") != -1){
//  				$('#picthree').attr('src',picUrl+data.image3);
//  			}else if(str4.indexOf("imgfour") != -1){
//  				$('#picfour').attr('src',picUrl+data.image4);
//  			}
//              alert(str.indexOf("imgone") != -1 );
//  			
	    		$('#picone').attr('src',picUrl+data.image1);
                $('#pictwo').attr('src',picUrl+data.image2);
	    		$('#picthree').attr('src',picUrl+data.image3);
	    		$('#picfour').attr('src',picUrl+data.image4);
    		}
    		
    		
    	}
    });
		</script>
	</body>
</html>
